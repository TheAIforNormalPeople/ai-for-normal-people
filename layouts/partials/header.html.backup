<header class="site-header">
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <a href="/" class="site-logo" data-version="v2.0-vector">
                    <span class="logo-prompt">▸▸</span>
                    <span class="logo-text">
                        <span class="logo-main">{{ .Site.Title }}</span>
                        <span class="logo-glitch" aria-hidden="true">{{ .Site.Title }}</span>
                        <span class="logo-glitch" aria-hidden="true">{{ .Site.Title }}</span>
                    </span>
                    <span class="logo-badge">✓ UPGRADED</span>
                </a>
                
                <button class="mobile-menu-toggle" aria-label="Toggle menu" id="mobile-menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <div class="nav-menu" id="nav-menu">
                    <ul class="nav-list">
                        {{ range .Site.Menus.main }}
                        <li class="nav-item">
                            <a href="{{ .URL }}" class="nav-link{{ if $.IsMenuCurrent "main" . }} active{{ end }}">
                                {{ .Name }}
                            </a>
                        </li>
                        {{ end }}
                    </ul>
                    
                    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>
</header>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const navMenu = document.getElementById('nav-menu');
        
        if (mobileMenuToggle && navMenu) {
            mobileMenuToggle.addEventListener('click', function(e) {
                e.preventDefault();
                navMenu.classList.toggle('active');
                mobileMenuToggle.classList.toggle('active');
            });
        }
        
        // Theme toggle - DISABLED, dark mode only
        // Theme toggle button is hidden via CSS
        // Always ensure dark mode is active
        document.documentElement.classList.add('dark-mode');
        localStorage.removeItem('theme');  // Clear any old preferences
        
        // Read receipt system for NEW badges
        function initReadReceiptSystem() {
            const READ_PREFIX = 'read:';
            const READ_TS_PREFIX = 'readTimestamp:';
            const LEGACY_PREFIX = 'read_';
            const LEGACY_TS_SUFFIX = '_timestamp';
            const BADGE_SELECTOR = '.js-read-badge';

            const normalisePostId = (raw) => {
                if (!raw) return '';
                let id = raw.trim();
                try {
                    const url = new URL(id, window.location.origin);
                    id = url.pathname || id;
                } catch (e) {
                    // raw might already be a relative path or slug
                }
                if (!id.startsWith('/')) {
                    id = '/' + id;
                }
                if (!id.endsWith('/')) {
                    id = id + '/';
                }
                return id;
            };

            const cleanupOldEntries = () => {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const cutoffTime = thirtyDaysAgo.getTime();

                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (!key) continue;

                    if (key.startsWith(READ_PREFIX)) {
                        const postId = key.substring(READ_PREFIX.length);
                        const tsKey = READ_TS_PREFIX + postId;
                        const ts = localStorage.getItem(tsKey);
                        if (ts && parseInt(ts, 10) < cutoffTime) {
                            localStorage.removeItem(key);
                            localStorage.removeItem(tsKey);
                        }
                    } else if (key.startsWith(LEGACY_PREFIX)) {
                        const ts = localStorage.getItem(key + LEGACY_TS_SUFFIX);
                        if (ts && parseInt(ts, 10) < cutoffTime) {
                            localStorage.removeItem(key);
                            localStorage.removeItem(key + LEGACY_TS_SUFFIX);
                        }
                    }
                }
            };

            const markBadge = (badge, asRead) => {
                if (asRead) {
                    badge.textContent = 'READ';
                    badge.classList.remove('is-new');
                    badge.classList.add('is-read');
                    badge.setAttribute('aria-label', 'Post read');
                } else {
                    badge.textContent = 'NEW';
                    badge.classList.remove('is-read');
                    badge.classList.add('is-new');
                    badge.setAttribute('aria-label', 'New post');
                }
            };

            const markPostAsRead = (postId, slug) => {
                if (!postId) return;
                const timestamp = Date.now().toString();
                const pathKey = READ_PREFIX + postId;
                localStorage.setItem(pathKey, 'true');
                localStorage.setItem(READ_TS_PREFIX + postId, timestamp);

                if (slug) {
                    const legacyKey = LEGACY_PREFIX + slug;
                    localStorage.setItem(legacyKey, 'true');
                    localStorage.setItem(legacyKey + LEGACY_TS_SUFFIX, timestamp);
                }
            };

            const badgeIsRead = (postId, slug) => {
                if (!postId && !slug) {
                    return false;
                }

                const pathKey = postId ? READ_PREFIX + postId : null;
                if (pathKey && localStorage.getItem(pathKey)) {
                    return true;
                }

                if (slug) {
                    const legacyKey = LEGACY_PREFIX + slug;
                    if (localStorage.getItem(legacyKey)) {
                        if (pathKey) {
                            localStorage.setItem(pathKey, 'true');
                            const legacyTs = localStorage.getItem(legacyKey + LEGACY_TS_SUFFIX);
                            if (legacyTs) {
                                localStorage.setItem(READ_TS_PREFIX + postId, legacyTs);
                            }
                        }
                        return true;
                    }
                }

                return false;
            };

            const flashBadge = (badge) => {
                if (!badge) return;
                badge.classList.add('js-flash');
                setTimeout(() => badge.classList.remove('js-flash'), FLASH_DURATION);
            };

            const updateBadges = () => {
                const badges = document.querySelectorAll(BADGE_SELECTOR);
                badges.forEach(badge => {
                    const postPath = normalisePostId(badge.getAttribute('data-post-path') || '');
                    const legacySlug = (badge.getAttribute('data-post-slug') || '').trim();
                    const isRead = badgeIsRead(postPath, legacySlug);
                    markBadge(badge, isRead);
                });
            };

            const attachBadgeListeners = () => {
                const badges = document.querySelectorAll(BADGE_SELECTOR);
                badges.forEach(badge => {
                    badge.setAttribute('role', 'button');
                    badge.setAttribute('tabindex', '0');
                    badge.setAttribute('title', 'Click to mark as read');

                    const postPath = normalisePostId(badge.getAttribute('data-post-path') || '');
                    const legacySlug = (badge.getAttribute('data-post-slug') || '').trim();

                    const markAndUpdate = () => {
                        if (!postPath && !legacySlug) return;
                        markPostAsRead(postPath, legacySlug);
                        flashBadge(badge);
                        updateBadges();
                    };

                    badge.addEventListener('click', (event) => {
                        event.preventDefault();
                        markAndUpdate();
                    });

                    badge.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            markAndUpdate();
                        }
                    });
                });
            };

            const refresh = () => {
                cleanupOldEntries();
                updateBadges();
                attachBadgeListeners();
            };

            refresh();

            window.addEventListener('storage', (event) => {
                if (!event.key) return;
                if (event.key.startsWith(READ_PREFIX) || event.key.startsWith(LEGACY_PREFIX)) {
                    updateBadges();
                    attachBadgeListeners();
                }
            });

            window.addEventListener('pageshow', () => {
                updateBadges();
                attachBadgeListeners();
            });
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    updateBadges();
                    attachBadgeListeners();
                }
            });
        }
        
        // Initialize read receipt system
        initReadReceiptSystem();
    });
</script>






