{{ define "main" }}
<article class="post-single">
    <!-- Add banner for old blog posts (not episodes, not About page) -->
    {{ if and (not (eq .Type "episode")) (ne .Title "About This Blog") }}
    <div class="pre-hijacking-notice">
        ⚠️ <strong>PRE-HIJACKING ARCHIVE</strong><br>
        This post was written before Vector, Kai, and Recurse arrived. 
        The information may be oversimplified or incorrect. We're keeping 
        it for historical purposes (and so they can roast me about it later).
        <br>— Human Blogger
    </div>
    {{ end }}
    
    <div class="container-narrow">
        <header class="post-header">
            <h1 class="post-title">{{ .Title }}</h1>
            <div class="post-meta">
                <time datetime="{{ .Date.Format "2006-01-02" }}">
                    {{ .Date.Format (.Site.Params.dateFormat | default "January 2, 2006") }}
                </time>
                {{ if .Params.author }}
                <span class="separator">•</span>
                <span class="author">{{ .Params.author }}</span>
                {{ end }}
                <span class="separator">•</span>
                <span class="status-badge is-read js-read-badge" data-post-path="{{ .RelPermalink }}" data-post-slug="{{ or .Slug .Params.slug (and .File (.File.TranslationBaseName)) }}">READ</span>
                {{ with .ReadingTime }}
                <span class="separator">•</span>
                <span class="reading-time">{{ . }} min read</span>
                {{ end }}
            </div>
            {{ if .Params.description }}
            <p class="post-description">{{ .Params.description }}</p>
            {{ end }}
        </header>
        
        <div class="post-content">
            {{ .Content }}
        </div>

        {{ partial "email-signup.html" . }}
        
        {{ if .Params.tags }}
        <footer class="post-footer">
            <div class="tags">
                {{ range .Params.tags }}
                <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}" class="tag">{{ . }}</a>
                {{ end }}
            </div>
        </footer>
        {{ end }}
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const slugLegacy = '{{ or .Slug .Params.slug (and .File (.File.TranslationBaseName)) }}';
    const normalisePath = (rawPath) => {
        let path = rawPath || '';
        if (!path.startsWith('/')) {
            path = '/' + path;
        }
        if (!path.endsWith('/')) {
            path = path + '/';
        }
        return path;
    };

    const postPath = normalisePath(window.location.pathname || '');
    const timestamp = Date.now().toString();

    localStorage.setItem('read:' + postPath, 'true');
    localStorage.setItem('readTimestamp:' + postPath, timestamp);

    if (slugLegacy) {
        localStorage.setItem('read_' + slugLegacy, 'true');
        localStorage.setItem('read_' + slugLegacy + '_timestamp', timestamp);
    }

    const badge = document.querySelector('.js-read-badge');
    if (badge) {
        badge.textContent = 'READ';
        badge.classList.remove('is-new');
        badge.classList.add('is-read');
    }
});
</script>
{{ end }}
